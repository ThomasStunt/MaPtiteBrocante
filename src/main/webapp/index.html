<!DOCTYPE html>
<html>
	<head>
		<title>Braderie</title>
		<meta charset="utf-8">
		<!-- JQUERY -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
		<script src="other/jquery-ui.min.js"></script>

		<!-- GOOGLE MAP -->
		<script src="https://maps.googleapis.com/maps/api/js"
        async defer></script>

        <!-- BOOTSTRAP -->
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

		<!-- style pour google map-->
		<style>
	      #map {
	      	margin-left: auto;
  			margin-right: auto;
	        width: 1000px;
		    height: 500px;
		    background-color: #CCC;
	      }
	    </style>
	</head>	
	<body>
		<div class="container">

			<!-- Top -->
			<div>
				<h1>Accueil</h1>
				<hr>
			</div>

			<!-- différent boutons -->
			<div style="text-align:center">
				<button id="listBraderie" class="btn btn-default">Lister les braderies</button>
				<button id="addBraderie" class="btn btn-default">Ajouter une braderie</button>
				<button id="delBraderie" class="btn btn-default">Supprimer une braderie</button>
				<button id="showMap" class="btn btn-default">Afficher les braderies aux alentours</button>
			</div>
			<hr>

			<!-- div de google map -->
			<div id="map" style="display:none"></div>

			<!--  Bouton lister les braderies-->
			<div id="outputList">
				<script type="text/javascript">
					$('#listBraderie').click( function () {
						$("#outputAdd").hide();
						$("#outputDel").hide();
						$("#map").hide();
						$("#outputList").show();
						var res = "";
						$.ajax({
							url: "/v1/brocante",
							type: "GET",
							dataType: "json",
							success: function(json) {
								if(json[0] == null) {
									$("#outputList").html("Aucune brocante disponible.");
								} else {
									var res = "<div><table class=\"table table-striped table-bordered\" style=\"text-align:center\"><tr><td><b>Libelle</b></td><td><b>Ville</b></td><td><b>Date</b></td></tr><tr>";
									for(i in json) {
										res+="<td>"+json[i].libelle+"</td>";
										res+="<td>"+json[i].ville+"</td>";
										res+="<td>"+json[i].date+"</td>";
										res+="</tr><tr>"
				    					}
									res+="</tr></table></div>";
									$("#outputList").html(res);
								}
							},
							error: function(xhr, status, errorThrown) {
								alert("Something went wrong");
								console.log("xhr: ", xhr);
								console.log("status: ", status);
								console.log("errorThrown: ", errorThrown);
							}
						});
					});
				</script>
			</div>
			
			<!-- Bouton ajouter une braderie -->
			<div id="outputAdd" style="display:none;">
				<!-- Libelle -->
				<div>
					<label for="inputLibelle">Libelle brocante :</label>
					<input type="text" class="form-control" id="inputLibelle" placeholder="Libelle">
				</div>
				<!-- Ville -->
				<div>
					<label for="inputVille">Ville brocante :</label>
					<input type="text" class="form-control" id="inputVille" placeholder="Ville">
				</div>
				<!-- Date -->
				<div >
					<label for="intputDate">Date brocante :</label>
					<input type="text" class="form-control" id="inputDate" placeholder="Date">
				</div>
				<div>
					<br>
					<button type="submit" id="submit" class="btn btn-default">Envoyer</button>
					<script type="text/javascript">
						$("#submit").click(function() {
							/*
							  Récupération de la data du formulaire
							*/
							var dat = {
								libelle : document.getElementById("inputLibelle").value,
								ville: document.getElementById("inputVille").value,
								date: document.getElementById("inputDate").value
							};
							console.log(dat);
							/*
							  Transmission Ajax au serveur REST
							*/
							$.ajax({
								url: "/v1/brocante",
								type: "POST",
								dataType: "json",
			 					processData: false,
			    					contentType: "application/json; charset=UTF-8",
								data: JSON.stringify(dat),
								success: function(json) {
									$("#output").html("Brocante ajoutée !");
								},
								error: function(xhr, status, errorThrown) {
									alert("Something went wrong");
									console.log("xhr: ", xhr);
									console.log("status: ", status);
									console.log("errorThrown: ", errorThrown);
								},
							});

							$('#outputAdd #inputLibelle').val("");
							$('#outputAdd #inputVille').val("");
							$('#outputAdd #inputDate').val("");
						});
					</script>
				</div>
			</div>

			<!-- Boutton supprimer une braderie -->
			<div id="outputDel" style="display:none">
				<script type="text/javascript">
					$("#delBraderie").click(function() {
						$("#outputAdd").hide();
						$("#outputDel").show();
						$("#outputList").hide();
						$("#map").hide();
						showList();
					});

					deleteId = function(idx) {
						$.ajax({
							url: "v1/brocante/"+idx,
							type: "DELETE",
							success: function(json) {
								showList();	
							},
							error: function(xhr, status, errorThrown) {
								alert("Something went wrong");
								console.log("xhr: ", xhr);
								console.log("status: ", status);
								console.log("errorThrown: ", errorThrown);
							}
								
						});							
					};

					function showList () {
						var res = "<div><table class=\"table table-striped table-bordered\" style=\"text-align:center\"><tr><td><b>Id brocante</b></td><td><b>Libelle brocante</b></td><td></td></tr><tr>";

						$.ajax({
							url: "v1/brocante",
							type: "GET",
							dataType: "json",
							success: function(json) {
								if(json[0] == null) {
									$("#outputDel").html("Aucune brocante disponible.");
								} else {
									for(i in json) {
										var id = json[i].id;
										var lib = json[i].libelle;
										res+="<td>"+id+"</td><td>"+lib+"</td><td>"+"<button class=\"glyphicon glyphicon-remove\" onclick=\"deleteId("+id+")\">"+"</button></tr><tr>";
									}
									res+="</tr></table></div>";
									$("#outputDel").html(res);
								}
							}
						});
					};
				</script>

				<!-- JQUERY BOUTON AJOUTER BRADERIE ET MONTRER LA MAP -->
				<script>
					$("#addBraderie").click(function() {
						$("#outputAdd").show();

						$("#map").hide();
						$("#outputDel").hide();
						$("#outputList").hide();
					});

					$('#showMap').click( function () {
						$("#map").show();
						initMap();
						$("#outputAdd").hide();
						$("#outputDel").hide();
						$("#outputList").hide();

						function initMap() {
				        var mapDiv = document.getElementById('map');
				        var map = new google.maps.Map(mapDiv, {
				          center: {lat: 44.540, lng: -78.546},
				          zoom: 15
				        });
				        var infoWindow = new google.maps.InfoWindow({map: map});

						  // Try HTML5 geolocation.
						if (navigator.geolocation) {
						    navigator.geolocation.getCurrentPosition(function(position) {
						     	var pos = {
						        lat: position.coords.latitude,
						        lng: position.coords.longitude
						     };

						    infoWindow.setPosition(pos);
						    infoWindow.setContent('Vous êtes ici.');
						    map.setCenter(pos);
						    }, function() {
						      handleLocationError(true, infoWindow, map.getCenter());
						    });
						} else {
						    // Browser doesn't support Geolocation
						    handleLocationError(false, infoWindow, map.getCenter());
						}
					}

					function handleLocationError(browserHasGeolocation, infoWindow, pos) {
					 	infoWindow.setPosition(pos);
					 	infoWindow.setContent(browserHasGeolocation ?'Error: The Geolocation service failed.' :'Error: Your browser doesn\'t support geolocation.');
					}
					});
				</script>
			</div>	
		</div>	
	</body>	
</html>
