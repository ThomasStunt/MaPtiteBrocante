<!DOCTYPE html>
<html>
	<head>
		<title>Braderie</title>
		<meta charset="utf-8">
		<!-- JQUERY -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
		<script src="other/jquery-ui.min.js"></script>

		<!-- GOOGLE MAP -->
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDzBlA7Z8KWJX-5TUR6A5-4Qa19BfA2-_A"
        async defer></script>

        	<!-- BOOTSTRAP -->
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

		<!-- style pour google map-->
		<style>
		      	#map {
		      		margin-left: auto;
	  			margin-right: auto;
				width: 1000px;
			 	height: 500px;
			 	background-color: #CCC;
		      	}
	    	</style>

		<!-- Récupération cookies -->
		<script type="text/javascript">
			function getCookie(cname) {
				var name = cname + "=";
   				var ca = document.cookie.split(';');
				for(var i=0; i<ca.length; i++) {
					var c = ca[i];
					while(c.charAt(0) == ' ') {
						c = c.substring(1);
					}
					if(c.indexOf(name) == 0) {
						return c.substring(name.length, c.length);
					}				
				}
				return "";
			}

			function checkCookie() {
				var user = getCookie("name");
				if(user == "") {
					alert("Oh don't do it");
					document.location.href="connexion.html";
				}
			}

			$(document).ready( function () {
				checkCookie();
				if(getCookie("name")!="admin") {
					$("#delBraderie").hide();
					$("#outputBraderie").hide();
				}
			});
		
		</script>
	</head>	
	<body>
		<div class="container">

			<!-- Top -->
			<div>
				<h1>Accueil</h1>
				<hr>
			</div>

			<!-- différent boutons -->
			<div style="text-align:center">
				<button id="listBraderie" class="btn btn-default">Lister les braderies</button>
				<button id="addBraderie" class="btn btn-default">Ajouter une braderie</button>
				<button id="delBraderie" class="btn btn-default">Supprimer une braderie</button>
				<button id="showMap" class="btn btn-default">Afficher les braderies aux alentours</button>
			</div>
			<hr>

			<!-- div de google map -->
			<div id="map" style="display:none"></div>

			<!--  Bouton lister les braderies-->
			<div id="outputList">
				<script type="text/javascript">
					$('#listBraderie').click( function () {
						$("#outputAdd").hide();
						$("#outputDel").hide();
						$("#map").hide();
						$("#outputList").show();
						var res = "";
						$.ajax({
							url: "/v1/brocante",
							type: "GET",
							dataType: "json",
							success: function(json) {
								if(json[0] == null) {
									$("#outputList").html("Aucune brocante disponible.");
								} else {
									var res = "<div><table class=\"table table-striped table-bordered\" style=\"text-align:center\"><tr><td><b>Libelle</b></td><td><b>Ville</b></td><td><b>Date</b></td></tr><tr>";
									for(i in json) {
											res+="<td>"+json[i].libelle+"</td>";
											res+="<td>"+json[i].ville+"</td>";
											res+="<td>"+json[i].date+"</td>";
											res+="</tr><tr>"
				    					}
									res+="</tr></table></div>";
									$("#outputList").html(res);
								}
							},
							error: function(xhr, status, errorThrown) {
								alert("Something went wrong");
								console.log("xhr: ", xhr);
								console.log("status: ", status);
								console.log("errorThrown: ", errorThrown);
							}
						});
					});
				</script>
			</div>
			
			<!-- Bouton ajouter une braderie -->
			<div id="outputAdd" style="display:none;">
				<!-- NomBrocante -->
				<div class="form-group col-sm-10">
					<label for="inputNomBrocante">Nom de la brocante :</label>
					<input type="text" class="form-control" id="inputLibelle" placeholder="Nom brocante">
				</div>
				<!-- NomBrocanteur -->
				<div class="form-group col-sm-10">
					<label for="inputNomBrocanteur">Nom brocanteur :</label>
					<input type="text" class="form-control" id="inputNomBroc" placeholder="Nom brocanteur">
				</div>
				<!-- EmailBrocanteur -->
				<div class="form-group col-sm-10">
					<label for="inputEmailBrocanteur">Email brocanteur</label>
					<input type="text" class="form-control" id="inputMailBroc" placeholder="Email">
				</div>
				<!-- TelBrocanteur -->
				<div class="form-group col-sm-10">
					<label for="intputTelBrocanteur">Tel brocanteur</label>
					<input type="text" class="form-control" id="inputTelBroc" placeholder="Téléphone">
				</div>
				<!-- Pays -->
				<div class="form-group col-sm-10">
					<label for="inputPays">Pays brocante</label>
					<input type="text" class="form-control" id="inputPays" placeholder="Pays">
				</div>
				<!-- Departement -->
				<div class="form-group col-sm-10">
					<label for="inputDepartement">Département brocante</label>
					<input type="text" class="form-control" id="inputDepart" placeholder="Département">
				</div>
				<!-- Ville -->
				<div class="form-group col-sm-10">
					<label for="inputVille">Ville brocante</label>
					<input type="text" class="form-control" id="inputVille" placeholder="Ville">
				</div>
				<!-- CodePostal -->
				<div class="form-group col-sm-10">
					<label for="inputCodePostal">Code postal brocante</label>
					<input type="text" class="form-control" id="inputCPostal" placeholder="Code postal">
				</div>
				<!-- Rue -->
				<div class="form-group col-sm-10">
					<label for="inputAddr">Nom de la brocante</label>
					<input type="text" class="form-control" id="inputAddr1" placeholder="Adresse 1">
					<input type="text" class="form-control" id="inputAddr2" placeholder="Adresse 2">
					<input type="text" class="form-control" id="inputAddr3" placeholder="Adresse 3">
					<input type="text" class="form-control" id="inputAddr4" placeholder="Adresse 4">
				</div>
				<!-- Date -->
				<div class="form-group col-sm-10">
					<label for="inputDate">Date brocante</label>
					<input type="text" class="form-control" id="inputDate" placeholder="Date">
				</div>
				<!-- HeureDeb -->
				<div class="form-group col-sm-10">
					<label for="inputHDeb">Heure début</label>
					<input type="text" class="form-control" id="inputHDeb" placeholder="Heure du début">
				</div>
				<!-- HeureFin -->
				<div class="form-group col-sm-10">
					<label for="inputHDeb">Heure fin</label>
					<input type="text" class="form-control" id="inputHFin" placeholder="Heure de fin">
				</div>
				<!-- Salle -->
				<div class="form-group col-sm-10">
					<label for="inputSalle">Salle</label>
					<input type="text" class="form-control" id="inputSalle" placeholder="Salle">
				</div>
				<!-- AcessHandic -->
				<div class="form-group col-sm-10">
					<label for="inputHandic">Handic</label>
					<br><input type="checkbox" id="handicY"> Oui.
					<br><input type="checkbox" id="handicN"> Non.
				</div>
				<!-- PrixEmplacement -->
				<div class="form-group col-sm-10">
					<label for="inputPrix">Prix emplacement</label>
					<input type="text" class="form-control" id="inputPrix" placeholder="Prix">
				</div>
				<div>
					<br>
					<button type="submit" id="submit" class="btn btn-default">Envoyer</button>
					<script type="text/javascript">
						$("#submit").click(function() {
							/*
							  Récupération de la data du formulaire
							*/
							var handic = function() {
								if($("#handicY").attr('checked', true)) {
									return true;
								} else {
									return false;
								}
							}

							var dat = {
								libelle : $("#inputLibelle").val(),

								nomOrganisateur: $("#inputNomBroc").val(),
								emailOrganisateur: $("#inputMailBroc").val(),
								telOrganisateur: $("#inputTelBroc").val(),

								pays: $("#inputPays").val(),
								departement: $("#inputDepart").val(),
								codePostal: $("#inputCPostal").val(),
								ville: $("#inputVille").val(),
								rue : $("#inputAddr1").val()+" "+$("#inputAddr2").val()+" "+$("#inputAddr3").val()+" "+$("#inputAddr4").val(),

								date: $("#inputDate").val(),
								heure_debut : $("#inputHDeb").val(),
								heure_fin : $("#inputHFin").val(),

								salle: $("#inputSalle").val(),
								handicape : handic,
								prixEmplacement : $("#inputPrix").val(),
								valide: false
							};
							console.log(dat);
							/*
							  Transmission Ajax au serveur REST
							*/
							$.ajax({
								url: "/v1/brocante",
								type: "POST",
								dataType: "json",
			 					processData: false,
			    					contentType: "application/json; charset=UTF-8",
								data: JSON.stringify(dat),
								success: function(json) {
									$("#output").html("Brocante ajoutée !");
								},
								error: function(xhr, status, errorThrown) {
									alert("Something went wrong");
									console.log("xhr: ", xhr);
									console.log("status: ", status);
									console.log("errorThrown: ", errorThrown);
								},
							});
							$('#outputAdd #inputLibelle').val("");
							$('#outputAdd #inputNomBroc').val("");
							$('#outputAdd #inputMailBroc').val("");
							$('#outputAdd #inputTelBroc').val("");
							$('#outputAdd #inputPays').val("");
							$('#outputAdd #inputDepart').val("");
							$('#outputAdd #inputCPostal').val("");
							$('#outputAdd #inputVille').val("");
							$('#outputAdd #inputRue').val("");
							$('#outputAdd #inputDate').val("");
							$('#outputAdd #inputHDeb').val("");
							$('#outputAdd #inputHFin').val("");
							$('#outputAdd #inputSalle').val("");
							$('#outputAdd #handicY').attr('checked', false);
							$('#outputAdd #handicN').attr('checked', false);
							$('#outputAdd #inputPrix').val("");
						});
					</script>
				</div>
				<div class="form-group col-sm-10" id="output">

				</div>
			</div>

			<!-- Boutton supprimer une braderie -->
			<div id="outputDel" style="display:none">
				<script type="text/javascript">
					$("#delBraderie").click(function() {
						$("#outputAdd").hide();
						$("#outputDel").show();
						$("#outputList").hide();
						$("#map").hide();
						showList();
					});
					deleteId = function(idx) {
						$.ajax({
							url: "v1/brocante/"+idx,
							type: "DELETE",
							success: function(json) {
								showList();	
							},
							error: function(xhr, status, errorThrown) {
								alert("Something went wrong");
								console.log("xhr: ", xhr);
								console.log("status: ", status);
								console.log("errorThrown: ", errorThrown);
							}
								
						});							
					};
					function showList () {
						var res = "<div><table class=\"table table-striped table-bordered\" style=\"text-align:center\"><tr><td><b>Id brocante</b></td><td><b>Libelle brocante</b></td><td></td></tr><tr>";
						$.ajax({
							url: "v1/brocante",
							type: "GET",
							dataType: "json",
							success: function(json) {
								if(json[0] == null) {
									$("#outputDel").html("Aucune brocante disponible.");
								} else {
									for(i in json) {
										var id = json[i].id;
										var lib = json[i].libelle;
										res+="<td>"+id+"</td><td>"+lib+"</td><td>"+"<button class=\"glyphicon glyphicon-remove\" onclick=\"deleteId("+id+")\">"+"</button></tr><tr>";
									}
									res+="</tr></table></div>";
									$("#outputDel").html(res);
								}
							}
						});
					};
				</script>

				<!-- JQUERY BOUTON AJOUTER BRADERIE ET MONTRER LA MAP -->
				<script>
					$("#addBraderie").click(function() {
						$("#outputAdd").show();
						$("#map").hide();
						$("#outputDel").hide();
						$("#outputList").hide();
					});
					$('#showMap').click( function () {
						$("#map").show();
						initMap();
						$("#outputAdd").hide();
						$("#outputDel").hide();
						$("#outputList").hide();
						getInformationBraderie();
					});

					var braderies = [];

					function getInformationBraderie (){
						$.ajax({
							url: "/v1/brocante",
							type: "GET",
							dataType: "json",
							success: function(json) {
								if(json[0] == null) {
									//a afficher il n'y a pas de braderie aux alentours
								} else {
									for(i in json) {
										var info = [json[i].codePostal, json[i].ville, json[i].rue, json[i].date, json[i].heure_debut, json[i].heure_fin];
										braderies.push(info);
				    				}
				    				utiliserLaListe();
								}
							},
							error: function(xhr, status, errorThrown) {
								alert("Something went wrong");
								console.log("xhr: ", xhr);
								console.log("status: ", status);
								console.log("errorThrown: ", errorThrown);
							}
						});
					}

					function utiliserLaListe(){	
						//console.log(braderies);
						//for(var i; i < braderies.length; i++){
							console.log(braderies[0]);
							/*$.ajax({
								url: "https://maps.googleapis.com/maps/api/geocode/json?address="+braderies[0].rue +",+" + braderies[0].ville,
								type: "GET",
								dataType: "json",
								success: function(json) {
									console.log(json);
								},
								error: function(xhr, status, errorThrown) {
									alert("Something went wrong");
									console.log("xhr: ", xhr);
									console.log("status: ", status);
									console.log("errorThrown: ", errorThrown);
								}
							});*/
						//}
					};

					function initMap() {
						var mapDiv = document.getElementById('map');
						var map = new google.maps.Map(mapDiv, {
						  center: {lat: 44.540, lng: -78.546},
						  zoom: 15
						});

				        var infoWindow = new google.maps.InfoWindow({map: map});
						  // Try HTML5 geolocation.
						if (navigator.geolocation) {
						    navigator.geolocation.getCurrentPosition(function(position) {
						     	var pos = {
						        lat: position.coords.latitude,
						        lng: position.coords.longitude
						     };
						    infoWindow.setPosition(pos);
						    infoWindow.setContent('Vous êtes ici.');
						    map.setCenter(pos);
						    }, function() {
						      handleLocationError(true, infoWindow, map.getCenter());
						    });
						} else {
						    // Browser doesn't support Geolocation
						    handleLocationError(false, infoWindow, map.getCenter());
						}
					};

					function handleLocationError(browserHasGeolocation, infoWindow, pos) {
					 	infoWindow.setPosition(pos);
					 	infoWindow.setContent(browserHasGeolocation ?'Error: The Geolocation service failed.' :'Error: Your browser doesn\'t support geolocation.');
					}
					
				</script>
			</div>	
		</div>	
	</body>	
</html>
